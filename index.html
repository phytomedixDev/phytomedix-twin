<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phytomedix | Digital Twin v27.0</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DESIGN SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root {
    --forest:   #1a3d2b;
    --green:    #2e7d4f;
    --leaf:     #4caf71;
    --mint:     #e6f5ec;
    --gold:     #c8a84b;
    --sky:      #e8f4fd;
    --ink:      #1a2332;
    --slate:    #4a5568;
    --mist:     #f7f9f8;
    --white:    #ffffff;
    --border:   #e2e8e5;
    --red:      #c53030;
    --amber:    #d97706;

    /* Evolution status colors */
    --improving: #2e7d4f;
    --stable:    #2563eb;
    --declining: #c53030;
    --baseline:  #6b7280;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--mist);
    color: var(--ink);
    min-height: 100vh;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .site-header {
    width: 100%;
    max-width: 680px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0 28px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 28px;
  }
  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    color: var(--forest);
    letter-spacing: -0.3px;
  }
  .logo span { color: var(--leaf); }
  .engine-badge {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    color: var(--green);
    background: var(--mint);
    border: 1px solid #b7d9c3;
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: 0.5px;
  }

  .container { width: 100%; max-width: 680px; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--white);
    border-radius: 16px;
    padding: 28px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.05), 0 0 0 1px var(--border);
    margin-bottom: 16px;
  }
  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--slate);
    margin-bottom: 20px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ INPUT FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #formCard h2 {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    color: var(--forest);
    margin-bottom: 6px;
  }
  #formCard .subtitle {
    font-size: 13px;
    color: var(--slate);
    margin-bottom: 24px;
  }

  .field-row { display: grid; gap: 12px; margin-bottom: 14px; }
  .field-row.two-col { grid-template-columns: 1fr 1fr; }

  .field-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    color: var(--slate);
    margin-bottom: 6px;
    text-transform: uppercase;
  }

  input[type="text"],
  input[type="number"],
  input[type="email"],
  select {
    width: 100%;
    padding: 11px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--ink);
    background: var(--white);
    transition: border-color 0.15s;
    -webkit-appearance: none;
  }
  input:focus, select:focus { outline: none; border-color: var(--green); }

  /* Clinical signal grid */
  .signals-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--slate);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
    display: block;
  }
  .signal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 14px;
  }
  .signal-label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    color: var(--ink);
    cursor: pointer;
    transition: all 0.15s;
    background: var(--white);
  }
  .signal-label:hover { background: var(--mint); border-color: #b7d9c3; }
  .signal-label input[type="checkbox"] { display: none; }
  .signal-label .dot {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-radius: 4px;
    flex-shrink: 0;
    transition: all 0.15s;
    position: relative;
  }
  .signal-label input:checked ~ .dot {
    background: var(--green);
    border-color: var(--green);
  }
  .signal-label input:checked ~ .dot::after {
    content: '';
    position: absolute;
    left: 3px; top: 1px;
    width: 6px; height: 9px;
    border: 2px solid white;
    border-top: none; border-left: none;
    transform: rotate(45deg);
  }
  .signal-label:has(input:checked) {
    border-color: var(--green);
    background: var(--mint);
  }
  .signal-label .icon { font-size: 14px; }

  .carb-row {
    display: flex; align-items: center; gap: 10px;
    padding: 11px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    font-size: 13px;
    color: var(--slate);
    transition: all 0.15s;
    margin-bottom: 20px;
  }
  .carb-row:has(input:checked) { border-color: var(--amber); background: #fffbf0; color: var(--ink); }
  .carb-row input { display: none; }
  .carb-check {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-radius: 4px; flex-shrink: 0;
  }
  .carb-row:has(input:checked) .carb-check {
    background: var(--amber); border-color: var(--amber);
  }

  .cta-btn {
    width: 100%;
    padding: 15px;
    background: var(--forest);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.3px;
    transition: all 0.2s;
    position: relative;
  }
  .cta-btn:hover { background: var(--green); transform: translateY(-1px); }
  .cta-btn:active { transform: translateY(0); }
  .cta-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #loadingOverlay {
    display: none;
    text-align: center;
    padding: 40px 0;
  }
  .spinner-dna {
    font-size: 48px;
    animation: spin-dna 2s ease-in-out infinite;
    display: inline-block;
    margin-bottom: 16px;
  }
  @keyframes spin-dna { 0%,100% { transform: scale(1); } 50% { transform: scale(1.2) rotate(10deg); } }
  .loading-stage {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--green);
    letter-spacing: 0.5px;
    min-height: 20px;
  }
  .loading-sub { font-size: 12px; color: var(--slate); margin-top: 6px; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #dashboard { display: none; animation: fadeUp 0.5s ease; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  /* Coach message */
  .coach-bar {
    background: linear-gradient(135deg, var(--forest) 0%, #1f4d36 100%);
    color: white;
    padding: 18px 22px;
    border-radius: 14px;
    margin-bottom: 16px;
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }
  .coach-icon { font-size: 20px; flex-shrink: 0; margin-top: 1px; }
  .coach-text { font-size: 13px; line-height: 1.65; color: rgba(255,255,255,0.9); }

  /* Stats grid */
  .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .stat-tile {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 14px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .stat-tile::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
    background: var(--green);
  }
  .stat-tile.declining::after { background: var(--red); }
  .stat-tile.improving::after { background: var(--leaf); }
  .stat-label { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--slate); font-weight: 600; margin-bottom: 8px; }
  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 800;
    color: var(--forest);
    line-height: 1;
  }
  .stat-sub { font-size: 10px; color: var(--slate); margin-top: 5px; }
  .momentum-arrow { font-size: 18px; vertical-align: middle; }

  /* Second stats row: cycle, projection, bio delta */
  .stats-row-2 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .meta-tile {
    background: var(--mint);
    border: 1px solid #c8e6d5;
    border-radius: 12px;
    padding: 12px 14px;
    text-align: center;
  }
  .meta-label { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--green); font-weight: 700; margin-bottom: 5px; }
  .meta-value { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 500; color: var(--forest); }

  /* Evolution badge */
  .evo-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 16px;
  }
  .evo-badge.baseline  { background: #f3f4f6; color: var(--baseline); border: 1px solid #d1d5db; }
  .evo-badge.improving { background: #dcfce7; color: var(--improving); border: 1px solid #bbf7d0; }
  .evo-badge.stable    { background: #dbeafe; color: var(--stable);   border: 1px solid #bfdbfe; }
  .evo-badge.declining { background: #fee2e2; color: var(--declining); border: 1px solid #fecaca; }

  /* Radar chart */
  .chart-wrap {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .chart-wrap canvas { max-height: 280px; }

  /* Protocol stacks */
  .stack-header {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--forest);
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .supp-card {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 10px;
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.15s;
  }
  .supp-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.07); }
  .supp-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--green);
  }
  .supp-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 6px; }
  .supp-name { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; color: var(--ink); }
  .supp-dose-tag {
    background: var(--mint);
    color: var(--forest);
    padding: 3px 9px;
    border-radius: 6px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .supp-hero { font-size: 12px; color: var(--green); font-style: italic; margin-bottom: 8px; display: block; line-height: 1.4; }
  .supp-ing { font-size: 11px; color: var(--slate); margin-bottom: 10px; display: block; }

  details.clinical-details {
    background: var(--mist);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  details.clinical-details summary {
    cursor: pointer;
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    color: var(--green);
    letter-spacing: 0.3px;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  details.clinical-details summary::-webkit-details-marker { display: none; }
  details.clinical-details summary::before { content: 'â–¶'; font-size: 8px; transition: transform 0.15s; }
  details[open].clinical-details summary::before { transform: rotate(90deg); }
  .clinical-body { padding: 12px; display: grid; gap: 6px; }
  .clinical-row { font-size: 11px; color: var(--ink); line-height: 1.5; }
  .clinical-row strong { color: var(--slate); }
  .clinical-row.warn { color: var(--red); }

  .empty-stack { padding: 14px; text-align: center; font-size: 13px; color: var(--slate); font-style: italic; }

  /* Lifestyle cards */
  .life-card {
    background: #fffbf0;
    border: 1px solid #f3e0a8;
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 10px;
  }
  .life-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .life-cat {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    font-weight: 500;
    color: var(--amber);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .life-title { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--ink); margin-bottom: 5px; }
  .life-text { font-size: 12px; color: var(--slate); line-height: 1.6; }

  /* Reset */
  .reset-btn {
    width: 100%;
    padding: 12px;
    background: none;
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--slate);
    font-size: 13px;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.15s;
  }
  .reset-btn:hover { background: var(--mist); border-color: var(--slate); }

  /* Responsive */
  @media (max-width: 480px) {
    .stats-row { grid-template-columns: 1fr 1fr; }
    .stats-row .stat-tile:last-child { grid-column: span 2; }
    .stats-row-2 { grid-template-columns: 1fr 1fr 1fr; }
    .signal-grid { grid-template-columns: 1fr; }
    .field-row.two-col { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header class="site-header">
  <div class="logo">PHYTO<span>MEDIX</span></div>
  <span class="engine-badge">ENGINE v27.0</span>
</header>

<div class="container">

  <!-- â•â• INPUT FORM â•â• -->
  <div class="card" id="formCard">
    <h2>Twin Calibration</h2>
    <p class="subtitle">6-Domain analysis Â· ERP-integrated Â· Full catalog selection</p>

    <div class="field-row">
      <div>
        <label class="field-label">Email address</label>
        <input type="email" id="email" placeholder="your@email.com">
      </div>
    </div>

    <div class="field-row two-col">
      <div>
        <label class="field-label">Age</label>
        <input type="number" id="age" placeholder="35" value="35" min="18" max="100">
      </div>
      <div>
        <label class="field-label">Biological sex</label>
        <select id="gender">
          <option value="Female">Female</option>
          <option value="Male">Male</option>
        </select>
      </div>
    </div>

    <span class="signals-label">Clinical signals â€” select all that apply</span>
    <div class="signal-grid">
      <label class="signal-label">
        <input type="checkbox" id="sym_diabetes" value="Diabetes Type 2">
        <span class="dot"></span>
        <span class="icon">ğŸ©¸</span> High Blood Sugar
      </label>
      <label class="signal-label">
        <input type="checkbox" id="sym_bp" value="Hypertension">
        <span class="dot"></span>
        <span class="icon">â¤ï¸</span> High Blood Pressure
      </label>
      <label class="signal-label">
        <input type="checkbox" id="sym_brain" value="Brain Fog">
        <span class="dot"></span>
        <span class="icon">ğŸ§ </span> Brain Fog / Focus
      </label>
      <label class="signal-label">
        <input type="checkbox" id="sym_joints" value="Joint Pain">
        <span class="dot"></span>
        <span class="icon">ğŸ¦´</span> Joint Inflammation
      </label>
      <label class="signal-label">
        <input type="checkbox" id="sym_gut" value="IBS">
        <span class="dot"></span>
        <span class="icon">ğŸŒ¿</span> IBS / Bloating
      </label>
      <label class="signal-label">
        <input type="checkbox" id="sym_hormone" value="Hormonal Imbalance">
        <span class="dot"></span>
        <span class="icon">âš¡</span> Hormonal / Libido
      </label>
    </div>

    <label class="carb-row" id="carbRow">
      <input type="checkbox" id="sym_carb">
      <span class="carb-check"></span>
      I eat a high carbohydrate diet
    </label>

    <button class="cta-btn" id="generateBtn" onclick="runEngine()">
      Generate Digital Twin Protocol
    </button>
  </div>

  <!-- â•â• LOADING â•â• -->
  <div id="loadingOverlay" class="card">
    <div class="spinner-dna">ğŸ§¬</div>
    <div class="loading-stage" id="loadingStage">Initializing engine...</div>
    <div class="loading-sub">Engine v27.0 Â· ERP-integrated Â· PRODUCT_CATALOG_DB</div>
  </div>

  <!-- â•â• DASHBOARD â•â• -->
  <div id="dashboard">

    <!-- Coach message -->
    <div class="coach-bar">
      <div class="coach-icon">ğŸ¤–</div>
      <div class="coach-text" id="disp_coach">â€”</div>
    </div>

    <!-- Evolution badge -->
    <div id="evo_badge_wrap"></div>

    <!-- Primary stats -->
    <div class="stats-row" id="stats_row">
      <div class="stat-tile" id="tile_score">
        <div class="stat-label">Functional Score</div>
        <div class="stat-value" id="disp_score">â€”</div>
        <div class="stat-sub">/100</div>
      </div>
      <div class="stat-tile" id="tile_bioage">
        <div class="stat-label">Biological Age</div>
        <div class="stat-value" id="disp_bioage">â€”</div>
        <div class="stat-sub">years</div>
      </div>
      <div class="stat-tile" id="tile_momentum">
        <div class="stat-label">Momentum</div>
        <div class="stat-value" id="disp_momentum">â€”</div>
        <div class="stat-sub" id="disp_momentum_sub">vs last cycle</div>
      </div>
    </div>

    <!-- Secondary stats -->
    <div class="stats-row-2">
      <div class="meta-tile">
        <div class="meta-label">Cycle</div>
        <div class="meta-value" id="disp_cycle">â€”</div>
      </div>
      <div class="meta-tile">
        <div class="meta-label">90d Proj.</div>
        <div class="meta-value" id="disp_proj">â€”</div>
      </div>
      <div class="meta-tile">
        <div class="meta-label">Multiplier</div>
        <div class="meta-value" id="disp_mult">â€”</div>
      </div>
    </div>

    <!-- Radar chart -->
    <div class="chart-wrap">
      <div class="card-title">6-Domain Load Map</div>
      <canvas id="twinRadar"></canvas>
    </div>

    <!-- AM Stack -->
    <div class="card" id="amCard">
      <div class="stack-header">â˜€ï¸ Morning Stack (AM)</div>
      <div id="am_list"></div>
    </div>

    <!-- PM Stack -->
    <div class="card" id="pmCard">
      <div class="stack-header">ğŸŒ™ Evening Stack (PM)</div>
      <div id="pm_list"></div>
    </div>

    <!-- Lifestyle -->
    <div class="card">
      <div class="stack-header">ğŸ¥— Lifestyle Engine</div>
      <div id="life_list"></div>
    </div>

    <button class="reset-btn" onclick="location.reload()">â†© New Assessment</button>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸  REPLACE WITH YOUR APPS SCRIPT DEPLOYMENT URL  âš ï¸
// Deploy: Extensions â†’ Apps Script â†’ Deploy â†’ Web App
// Execute as: Me Â· Access: Anyone
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = "https://script.google.com/macros/s/AKfycbz33Q_eHlcVxmaGXMFRRyUIVMbBiD5HhD5MDYyk1E0Qxcdb4BsNBevvzsCdKiPdjUr_Ag/exec";

// â”€â”€â”€ Loading stages â”€â”€â”€
const STAGES = [
  "Loading clinical profiles...",
  "Running 6-domain scoring...",
  "Querying PRODUCT_CATALOG_DB...",
  "Applying safety vetoes...",
  "Applying tier multipliers...",
  "Calculating Twin State...",
  "Writing TWIN_STATE + SNAPSHOTS...",
  "Generating coach message..."
];
let stageIdx = 0;
let stageTimer;

function startStages() {
  stageIdx = 0;
  document.getElementById("loadingStage").textContent = STAGES[0];
  stageTimer = setInterval(() => {
    stageIdx = (stageIdx + 1) % STAGES.length;
    document.getElementById("loadingStage").textContent = STAGES[stageIdx];
  }, 700);
}
function stopStages() { clearInterval(stageTimer); }

// â”€â”€â”€ Engine call â”€â”€â”€
function runEngine() {
  const email  = document.getElementById("email").value.trim();
  const age    = document.getElementById("age").value;
  const gender = document.getElementById("gender").value;

  if (!email) { alert("Please enter your email address."); return; }

  const q10 = [];
  if (document.getElementById("sym_diabetes").checked) q10.push("Diabetes Type 2");
  if (document.getElementById("sym_bp").checked)       q10.push("Hypertension");
  if (document.getElementById("sym_brain").checked)    q10.push("Brain Fog");
  if (document.getElementById("sym_joints").checked)   q10.push("Joint Pain");
  if (document.getElementById("sym_gut").checked)      q10.push("IBS");
  if (document.getElementById("sym_hormone").checked)  q10.push("Hormonal Imbalance");

  const payload = {
    email: email,
    age: age,
    "Q-002": gender,
    "Q-010": q10.join("; "),
    "Q-006": document.getElementById("sym_carb").checked ? "High carb" : "Balanced"
  };

  // Show loading
  document.getElementById("formCard").style.display = "none";
  document.getElementById("loadingOverlay").style.display = "block";
  startStages();

  const encodedPayload = encodeURIComponent(JSON.stringify(payload));
  const callbackName   = "cb_" + Math.floor(Math.random() * 1e8);

  window[callbackName] = function(data) {
    stopStages();
    delete window[callbackName];
    document.body.removeChild(script);
    document.getElementById("loadingOverlay").style.display = "none";

    if (data.status === "success") {
      renderDashboard(data.output);
    } else {
      document.getElementById("formCard").style.display = "block";
      alert("Engine error: " + (data.message || "Unknown error"));
    }
  };

  const script = document.createElement("script");
  script.src = API_URL + "?payload=" + encodedPayload + "&callback=" + callbackName;
  script.onerror = () => {
    stopStages();
    document.getElementById("loadingOverlay").style.display = "none";
    document.getElementById("formCard").style.display = "block";
    alert("Network error. Check your Apps Script URL and deployment settings.");
  };
  document.body.appendChild(script);
}

// â”€â”€â”€ Dashboard render â”€â”€â”€
function renderDashboard(twin) {
  document.getElementById("dashboard").style.display = "block";

  // Coach
  document.getElementById("disp_coach").textContent = twin.coachMessage || "";

  // Evolution badge
  const evo = (twin.evolutionStatus || "baseline").toLowerCase();
  const evoBadgeMap = {
    baseline: { icon: "â—", label: "BASELINE â€” CYCLE 1" },
    improving: { icon: "â†‘", label: "IMPROVING" },
    stable:    { icon: "â†’", label: "STABLE" },
    declining: { icon: "â†“", label: "DECLINING" }
  };
  const badge = evoBadgeMap[evo] || evoBadgeMap.baseline;
  document.getElementById("evo_badge_wrap").innerHTML =
    `<span class="evo-badge ${evo}">${badge.icon} ${badge.label}</span>`;

  // Primary stats
  document.getElementById("disp_score").textContent = twin.overallScore;
  document.getElementById("disp_bioage").textContent = twin.biologicalAge;

  const mom = parseFloat(twin.momentum) || 0;
  const momEl = document.getElementById("disp_momentum");
  if (evo === "baseline") {
    momEl.textContent = "â€”";
    document.getElementById("disp_momentum_sub").textContent = "first run";
  } else {
    const arrow = mom > 3 ? "â†‘" : (mom < -3 ? "â†“" : "â†’");
    const sign  = mom > 0 ? "+" : "";
    momEl.textContent = arrow + " " + sign + mom;
    momEl.style.color = mom > 3 ? "#2e7d4f" : (mom < -3 ? "#c53030" : "#2563eb");
    document.getElementById("disp_momentum_sub").textContent = "vs last cycle";
  }

  // Color tile bottom border
  document.getElementById("tile_score").className = "stat-tile " + evo;

  // Secondary stats
  document.getElementById("disp_cycle").textContent = "C" + (twin.cycleNumber || 1);
  document.getElementById("disp_proj").textContent  = (twin.projection90d || "â€”") + "/100";
  document.getElementById("disp_mult").textContent  = (twin.multiplier || 1.0).toFixed(1) + "x";

  // Radar chart
  renderRadar(twin.scores);

  // Protocol stacks
  renderStack(twin.protocol.AM, "am_list");
  renderStack(twin.protocol.PM, "pm_list");

  // Lifestyle
  renderLifestyle(twin.lifestyle || []);
}

function renderRadar(scores) {
  const ctx = document.getElementById("twinRadar").getContext("2d");
  new Chart(ctx, {
    type: "radar",
    data: {
      labels: ["Metabolic", "Cardio", "Cognitive", "Joints", "Gut", "Hormonal"],
      datasets: [{
        label: "Domain Load",
        data: [
          scores.metabolic, scores.cardio, scores.cognitive,
          scores.joints,    scores.gut,    scores.hormonal
        ],
        backgroundColor: "rgba(46, 125, 79, 0.15)",
        borderColor: "#2e7d4f",
        pointBackgroundColor: "#2e7d4f",
        pointBorderColor: "#fff",
        pointHoverBackgroundColor: "#fff",
        pointHoverBorderColor: "#2e7d4f",
        borderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          min: 0, max: 100,
          ticks: { display: false, stepSize: 25 },
          grid: { color: "rgba(0,0,0,0.06)" },
          pointLabels: { font: { family: "Inter", size: 11, weight: "600" }, color: "#4a5568" }
        }
      },
      plugins: { legend: { display: false } }
    }
  });
}

function renderStack(list, containerId) {
  const el = document.getElementById(containerId);
  if (!list || list.length === 0) {
    el.innerHTML = '<div class="empty-stack">No items for this time block.</div>';
    return;
  }
  el.innerHTML = list.map(item => {
    const doseParts = [item.dose || ""].concat(item.final_dose_mg ? [`${item.final_dose_mg}mg`] : []);
    return `
      <div class="supp-card">
        <div class="supp-top">
          <span class="supp-name">${esc(item.name)}</span>
          <span class="supp-dose-tag">${esc(doseParts.join(" Â· "))}</span>
        </div>
        ${item.hero ? `<span class="supp-hero">"${esc(item.hero)}"</span>` : ""}
        ${item.ingredients ? `<span class="supp-ing">ğŸ§ª ${esc(item.ingredients)}</span>` : ""}
        <details class="clinical-details">
          <summary>Clinical rationale</summary>
          <div class="clinical-body">
            ${item.why ? `<div class="clinical-row"><strong>Mechanism:</strong> ${esc(item.why)}</div>` : ""}
            ${item.safety ? `<div class="clinical-row warn"><strong>Safety note:</strong> ${esc(item.safety)}</div>` : ""}
            ${item.contraindications && item.contraindications !== "None" ? `<div class="clinical-row warn"><strong>Contraindications:</strong> ${esc(item.contraindications)}</div>` : ""}
          </div>
        </details>
      </div>`;
  }).join("");
}

function renderLifestyle(list) {
  const el = document.getElementById("life_list");
  if (!list || list.length === 0) { el.innerHTML = ""; return; }
  el.innerHTML = list.map(l => `
    <div class="life-card">
      <div class="life-meta">
        <span class="life-cat">${esc(l.category || "")}</span>
      </div>
      <div class="life-title">${esc(l.title || "")}</div>
      <div class="life-text">${esc(l.text || "")}</div>
    </div>`
  ).join("");
}

// XSS escape helper
function esc(str) {
  return String(str || "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
</script>
</body>
</html>

